const express = require("express");
const linebot = require("linebot");
require("dotenv").config();

const bot = linebot({
  channelId: process.env.CHANNEL_ID,
  channelSecret: process.env.CHANNEL_SECRET,
  channelAccessToken: process.env.CHANNEL_ACCESS_TOKEN
});

const app = express();

// LINEのWebhookを受け取る
const linebotParser = bot.parser();
app.post("/webhook", linebotParser);

bot.on("message", function (event) {
  const userInput = event.message.text; // 例: "カレーライス 200g"
  const [food, gramsStr] = userInput.split(" ");
  const grams = parseInt(gramsStr.replace("g", ""));

  // 仮の栄養計算（本当はDBやAPIから）
  const nutrition = {
    calories: (1.75 * grams).toFixed(1),
    protein: (0.05 * grams).toFixed(1),
    fat: (0.04 * grams).toFixed(1),
    carbs: (0.3 * grams).toFixed(1),
    vitaminA: 50,
    vitaminC: 12,
    calcium: 20,
    iron: 1.5
  };

  const reply = `
🍴 ${food} ${grams}g
カロリー: ${nutrition.calories} kcal
たんぱく質: ${nutrition.protein} g
脂質: ${nutrition.fat} g
炭水化物: ${nutrition.carbs} g
ビタミン: A ${nutrition.vitaminA}µg, C ${nutrition.vitaminC}mg
ミネラル: Ca ${nutrition.calcium}mg, Fe ${nutrition.iron}mg
  `;

  event.reply(reply);
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log("Server is running on port " + PORT);
});
